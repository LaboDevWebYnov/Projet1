/**
 * Created by Ezehollar on 14/01/2016.
 */

var logger = require('log4js').getLogger('Users'),
    mongoose = require('mongoose'),
    sanitizer = require('sanitizer'),
    _ = require('lodash'),
    Util = require('./utils/util.js'),
    PlayerAccountDB = require('../models/PlayerAccountDB'),
    PlayerAccount = mongoose.model('PlayerAccount'),
    AddressDB = require('../models/AddressDB'),
    Address = mongoose.model('Address'),
    UserDB = require('../models/UserDB'),
    User = mongoose.model('User'),
    GameDB = require('../models/GameDB'),
    Game = mongoose.model('Game');

//Path: GET api/players
module.exports.getPlayerAccountList = function getPlayerAccountList(req, res, next) {
    logger.info('Getting all players from db...');
    // Code necessary to consume the User API and respond
    PlayerAccount.find({}, function (err, playerAccountList) {
        if (err) {
            return next(err.message);
        }
        if (_.isNull(playerAccountList) || _.isEmpty(playerAccountList)) {
            res.set('Content-Type', 'application/json');
            res.status(404).json(JSON.stringify(playerAccountList || {}, null, 2));
        }
        else {
            res.set('Content-Type', 'application/json');
            res.end(JSON.stringify(playerAccountList || {}, null, 2));
        }
    });
};

//Path: GET api/playerAccount/{userId}/addPlayerAccount/{gameId}
module.exports.addPlayerAccount = function addPlayerAccount(req, res, next) {
    logger.info('Adding new playerAccount...');

    User.findOne(
        {_id: Util.getPathParams(req)[2]},
        function(err, userFinded) {

            Game.findOne(
                {_id: Util.getPathParams(req)[4]},
                function (err, gameFinded) {


                    var playerAccountToCreate = new PlayerAccount({
                        user: userFinded,
                        login: req.body.login,
                        game: gameFinded,
                        active: true,
                        created_at: new Date(),
                        updated_at: new Date()
                    });

                    logger.debug(playerAccountToCreate);

                    playerAccountToCreate.save(function (err,playerAccountFinded) {
                        if (err)
                            return next(err.message);

                        PlayerAccount.findOne(
                            {_id: playerAccountFinded._id})
                            .populate('user game')
                            .exec(
                                function(err, playedAccountUpdated) {
                                    if (err)
                                        logger.info(err.message);

                                    logger.debug(playedAccountUpdated);

                                    if (_.isNull(playedAccountUpdated) || _.isEmpty(playedAccountUpdated)) {
                                        res.set('Content-Type', 'application/json');
                                        res.status(404).json(JSON.stringify(playedAccountUpdated || {}, null, 2));
                                    }
                                    else {
                                        res.set('Content-Type', 'application/json');
                                        res.status(200).end(JSON.stringify(playedAccountUpdated || {}, null, 2));
                                    }
                                });

                    });

                });
        });

};

// Path: GET api/players/{playerAcountId}/getPlayerAccountById
module.exports.getPlayerAccountById = function getPlayerAccountById(req, res, next) {
    logger.debug('BaseUrl:' + req.originalUrl);
    logger.debug('Path:' + req.path);

    logger.info('Getting the player with id:' + Util.getPathParams(req)[1]);
    // Code necessary to consume the User API and respond

    PlayerAccount.findById(
        Util.getPathParams(req)[2],
        function (err, playerAccount) {
            if (err)
                return next(err.message);

            logger.debug(playerAccount);
            if (_.isNull(playerAccount) || _.isEmpty(playerAccount)) {
                res.set('Content-Type', 'application/json');
                res.status(404).json(JSON.stringify(playerAccount || {}, null, 2));
            }
            else {
                res.set('Content-Type', 'application/json');
                res.status(200).end(JSON.stringify(playerAccount || {}, null, 2));
            }
        }
    );
};

// Path: GET api/players/{playerAcountId}/getPlayerByUserId
module.exports.getPlayerByUserId = function getPlayerByUserId(req, res, next) {
    logger.debug('BaseUrl:' + req.originalUrl);
    logger.debug('Path:' + req.path);

    logger.info('Getting the player with id:' + Util.getPathParams(req)[1]);
    // Code necessary to consume the User API and respond

    PlayerAccount.find(
        { _id: Util.getPathParams(req)[1] },
        function (err, playerAccountList) {
            if (err)
                return next(err.message);

            logger.debug(playerAccountList);
            if (_.isNull(playerAccountList) || _.isEmpty(playerAccountList)) {
                res.set('Content-Type', 'application/json');
                res.status(404).json(JSON.stringify(playerAccountList || {}, null, 2));
            }
            else {
                res.set('Content-Type', 'application/json');
                res.status(200).end(JSON.stringify(playerAccountList || {}, null, 2));
            }
        }
    );
};

// Path : PUT /players/{playerId}/deletePlayer
module.exports.deletePlayer = function deletePlayer(req, res, next) {
    logger.info('Deactivating for player with id:\n '+Util.getPathParams(req)[2]);
    PlayerAccount.findOneAndUpdate(
        {_id: Util.getPathParams(req)[2]},
        {
            $set: {
                active: false
            }
        },
        {new: true}, //means we want the DB to return the updated document instead of the old one
        function (err, updatedPlayerAccount) {
            if (err)
                return next(err.message);

            logger.debug("Deactivated player object: \n" + updatedPlayerAccount);
            res.set('Content-Type', 'application/json');
            res.status(200).end(JSON.stringify(updatedPlayerAccount || {}, null, 2));

        });
};